name: Gemini Code Assist

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          [ -f requirements.txt ] && pip install -r requirements.txt
          pip install pytest pylint

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' | head -20 > changed.txt
          else
            git diff --name-only HEAD~1 -- '*.py' | head -20 > changed.txt
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat changed.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Static analysis on changed files
        id: analysis
        run: |
          FILES=$(cat changed.txt | tr '\n' ' ')
          if [ -n "$FILES" ]; then
            pylint $FILES --exit-zero --output-format=text \
              --disable=C0114,C0115,C0116,R0903 2>&1 | tee pylint-out.txt || true
          else
            echo "No Python files changed." > pylint-out.txt
          fi
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          tail -40 pylint-out.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AURA skills: complexity + security scan
        id: skills
        env:
          AURA_SKIP_CHDIR: "1"
        run: |
          python3 - <<'PYEOF' 2>&1 | tee skills-out.txt || true
          import sys, os
          os.environ["AURA_SKIP_CHDIR"] = "1"
          sys.path.insert(0, ".")
          try:
              from agents.skills.registry import all_skills
              skills = all_skills()
              project_root = "."
              results = {}
              if "complexity_scorer" in skills:
                  r = skills["complexity_scorer"].run({"project_root": project_root})
                  results["complexity"] = {
                      "high_risk_count": r.get("high_risk_count", 0),
                  }
              if "security_scanner" in skills:
                  r = skills["security_scanner"].run({"project_root": project_root})
                  results["security"] = {
                      "critical_count": r.get("critical_count", 0),
                      "findings": r.get("findings", [])[:3],
                  }
              for k, v in results.items():
                  print(f"{k}: {v}")
          except Exception as e:
              print(f"Skills scan skipped: {e}")
          PYEOF
          echo "skills<<EOF" >> $GITHUB_OUTPUT
          cat skills-out.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Gemini Code Assist summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const changed = `${{ steps.changed.outputs.files }}`;
            const analysis = `${{ steps.analysis.outputs.analysis }}`;
            const skills = `${{ steps.skills.outputs.skills }}`;
            const body = [
              '## âœ¨ Gemini Code Assist Review',
              '',
              '### Changed Python Files',
              '```',
              changed || 'None',
              '```',
              '',
              '### Static Analysis (pylint)',
              '```',
              analysis,
              '```',
              '',
              '### AURA Skills Scan (complexity + security)',
              '```',
              skills,
              '```',
              '',
              '_Powered by Gemini Code Assist + AURA Skills_',
            ].join('\n');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
