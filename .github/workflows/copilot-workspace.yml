name: GitHub Copilot Workspace

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      goal:
        description: "Goal to process with AURA loop"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  aura-goal-from-issue:
    name: AURA Goal from Issue
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'aura-goal')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          [ -f requirements.txt ] && pip install -r requirements.txt
          pip install pytest

      - name: Extract goal
        id: goal
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "goal=${{ github.event.inputs.goal }}" >> $GITHUB_OUTPUT
          else
            TITLE="${{ github.event.issue.title }}"
            echo "goal=${TITLE}" >> $GITHUB_OUTPUT
          fi

      - name: Add goal to AURA queue (dry run)
        env:
          AURA_SKIP_CHDIR: "1"
          AURA_DRY_RUN: "1"
        run: |
          python3 main.py --add-goal "${{ steps.goal.outputs.goal }}" || true
          echo "Goal queued: ${{ steps.goal.outputs.goal }}"

      - name: Acknowledge issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **Copilot Workspace**: Goal queued in AURA loop.\n\n> ' +
                    context.payload.issue.title +
                    '\n\n_AURA will process this goal in the next cycle._',
            });
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['aura-queued'],
            });
